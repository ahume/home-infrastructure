- name: Check if pihole service exists
  ansible.builtin.stat:
    path: /etc/init.d/pihole-FTL
  register: service_status

- name: Create /etc/pihole
  become: true
  ansible.builtin.file:
    path: /etc/pihole
    state: directory
    mode: 0655
    owner: pi
    group: pi

- name: Download install-pi-hole.sh
  ansible.builtin.get_url:
    url: https://install.pi-hole.net
    dest: /home/pi/install-pi-hole.sh
    mode: 0755
  when: not service_status.stat.exists

- name: Configuration pihole templates
  become: true
  ansible.builtin.template:
    src: "./templates/{{ item }}"
    dest: "/etc/pihole/{{ item }}"
    mode: 0655
    owner: pi
    group: pi
  tags:
    - config
  with_items:
    - setupVars.conf
    - custom.list
  notify: pihole-FTL Reload service

- name: Execute install-pi-hole.sh
  become: true
  ansible.builtin.command: /home/pi/install-pi-hole.sh --unattended
  when: not service_status.stat.exists

- name: Enable and stared service pihole
  ansible.builtin.service:
    name: pihole-FTL
    enabled: true
    state: started

- name: Pihole check version
  ansible.builtin.command: "pihole -v"
  register: pihole_version
  when: service_status.stat.exists

- name: Print pihole version
  ansible.builtin.debug:
    var: pihole_version.stdout_lines
